#!/usr/bin/env node
//#region @backend
// console.log('-- FIREDEV started... please wait. --')
// require('cache-require-paths');

global.hideLog = true;
global.verboseLevel = 0;
var verboseLevel = process.argv.find(a => a.startsWith('-verbose='));
if (typeof verboseLevel !== 'undefined') {
  global.hideLog = false;
  verboseLevel = Number(verboseLevel);
  if (!isNaN(verboseLevel)) {
    global.verboseLevel = verboseLevel;
  }
  process.argv = process.argv.filter(a => !a.startsWith('-verbose='));
}

if (process.argv.includes('-verbose')) {
  global.hideLog = false;
  process.argv = process.argv.filter(a => a !== '-verbose');
}

var distOnly = (process.argv.includes('-dist'));
var bundleOnly = (process.argv.includes('-bundle'));
if (distOnly) {
  !global.hideLog && console.log('- dist only -');
  // =========================== only dist ============================
  process.argv = process.argv.filter(a => a !== '-dist');
  process.argv = process.argv.filter(f => !!f);
  var path = require('path');
  var pathToDistRun = path.join(__dirname, '../dist/index.js');
  var start = require(pathToDistRun.replace(/\.js$/g, '')).start;
  global.tnp_normal_mode = true;
  global.tnp_out_folder = 'dist';
  // =======================================================================
} else if (bundleOnly) {
  !global.hideLog && console.log('- bundle only -');
  // =========================== only dist ============================
  process.argv = process.argv.filter(a => a !== '-bundle');
  process.argv = process.argv.filter(f => !!f);
  var path = require('path');
  var pathToDistRun = path.join(__dirname, '../bundle/index.js');
  var start = require(pathToDistRun.replace(/\.js$/g, '')).start;
  global.tnp_normal_mode = true;
  global.tnp_out_folder = 'bundle'
  // =======================================================================
} else {
  // =========================== TODO speeding up! ============================
  var fs = require('fs');
  var path = require('path');
  var ora = require('ora');
  var spinner = ora();

  global.spinner = spinner;
  // if (!isNaN(process.ppid)) {
  //   spinner.start();
  // }
  var pathToDistFolder = path.join(__dirname, '../dist');
  var pathToBundleFolder = path.join(__dirname, '../bundle');

  var pathToDistRun = path.join(__dirname, '../dist/index.js');
  var pathToBundletRun = path.join(__dirname, '../bundle/index.js');

  var distExist = fs.existsSync(pathToDistRun);
  var bundleExist = fs.existsSync(pathToBundletRun);

  var start;
  global.tnp_normal_mode = true;

  if (bundleExist && distExist) {
    if (fs.lstatSync(pathToDistFolder).mtimeMs > fs.lstatSync(pathToBundleFolder).mtimeMs) {
      !global.hideLog && console.log('- firedev dist -> becouse is newer -');
      global.tnp_out_folder = 'dist'
      start = require(pathToDistRun.replace(/\.js$/g, '')).start;
    } else {
      !global.hideLog && console.log('- firedev bundle -> becouse is newer -')
      global.tnp_out_folder = 'bundle'
      start = require(pathToBundletRun.replace(/\.js$/g, '')).start;
    }
  } else {
    if (bundleExist) {
      !global.hideLog && console.log('- firedev bundle -');
      global.tnp_out_folder = 'bundle'
      start = require(pathToBundletRun.replace(/\.js$/g, '')).start;
    } else {
      !global.hideLog && console.log('- firedev dist -');
      global.tnp_out_folder = 'dist'
      start = require(pathToDistRun.replace(/\.js$/g, '')).start;

    }
  }
  // =======================================================================
}
global.start = start;
// console.log('before start')
start(process.argv, 'tnp');
//#endregion
